#!/usr/bin/env python

import argparse
import logging
import os
import sys

import tqdm

import limbo.data

parser = argparse.ArgumentParser(description="Correct problems with Limbo dataset(s).")
parser.add_argument("--dry-run", action="store_true", help="Don't make changes.")
parser.add_argument("datadir", nargs="+", default=[], help="Limbo dataset director(ies).")
arguments = parser.parse_args()

logging.basicConfig(level=logging.INFO, format="%(message)s")
logging.getLogger("imagecat").setLevel(logging.WARN)

logging.info("Linting data in:")
for path in arguments.datadir:
    logging.info(f"  {path}")

dataset = limbo.data.Dataset(arguments.datadir)

for sample in tqdm.tqdm(dataset, desc="Samples", unit="sample"):
    if "annotations" in sample.metadata:
        annotations = []
        for annotation in sample.metadata["annotations"]:
            if "bbox" in annotation:
                x, y, width, height = annotation["bbox"]
                if width == 0 and height == 0:
                    logging.error(f"Found empty bounding box in {sample.path}.")
                    continue
            annotations.append(annotation)
        if annotations != sample.metadata["annotations"]:
            logging.info(f"Updating {sample.path} metadata.")
            if not arguments.dry_run:
                sample.update_metadata({"annotations": annotations})

